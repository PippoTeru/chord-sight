# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

**ChordLens** は、88鍵盤（A0～C8）のピアノ鍵盤を表示し、リアルタイムでコード検出を行うSvelteKitアプリケーションです。MIDI入力に対応しており、演奏したコードを即座に分析・表示します。音楽理論に基づいた正確なコード検出と、複数候補の表示機能を備えています。

**技術スタック:**
- SvelteKit 2.x + TypeScript
- Svelte 5.x（runes対応）
- Vite（ビルドツール）

## 開発コマンド

```bash
# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build

# 本番ビルドのプレビュー
npm run preview
```

## アーキテクチャ

### コンポーネント構成

最小限のコンポーネント構成を採用しています：

- **[src/lib/components/Piano.svelte](src/lib/components/Piano.svelte)** - ピアノ鍵盤の描画を行うメインコンポーネント（単一の自己完結型コンポーネント）
- **[src/routes/+page.svelte](src/routes/+page.svelte)** - Pianoコンポーネントをビューポート下部に配置するホームページ
- **[src/routes/+layout.svelte](src/routes/+layout.svelte)** - CSSリセットを読み込むルートレイアウト

### Pianoコンポーネントのアーキテクチャ

SVGベースのレンダリング方式を採用しています：

**データモデル:**
```typescript
interface PianoKey {
  note: string;        // 音名（例: "A", "A#", "C"）
  octave: number;      // オクターブ番号（0-8）
  midiNumber: number;  // MIDI音番号（21-108）
  isBlack: boolean;    // 黒鍵フラグ
  isActive: boolean;   // 将来のMIDIハイライト用
}
```

**鍵盤データの生成:**
- 白鍵（52個）と黒鍵（36個）を別々の配列で管理
- 描画順序：白鍵→黒鍵（SVGのz-index制御のため）

**SVG座標系:**
- ViewBox: `0 0 1223 151`（幅 = 白鍵52個 × 23.5 + 1pxマージン）
- すべての寸法と位置は固定座標系を使用し、レスポンシブにスケール

**黒鍵の配置アルゴリズム:**
N等分アルゴリズムを使用して黒鍵を配置：
- C～Eグループ: 3個の白鍵を5等分
- F～Bグループ: 4個の白鍵を7等分
- これにより、白鍵の見える部分が均等に配置されます

詳細な数式と位置計算については[specifications.md](specifications.md)を参照してください。

### 将来のMIDI統合

`PianoKey`の`isActive`フラグは、MIDI入力受信時の鍵盤ハイライト表示用に予約されています。この機能は計画中ですが、まだ実装されていません。Web MIDI APIを追加する際は、アプリケーションがHTTPSで動作する必要があります。

## 重要な実装詳細

1. **座標計算**: すべての鍵盤位置は数学的に計算されており、ハードコードされていません。`getWhiteKeyIndex()`と`getBlackKeyX()`関数が複雑な配置ロジックを処理しています。

2. **下部角丸**: 鍵盤は、実際のピアノ鍵盤を模倣するため、カスタムSVGパス（`createRoundedBottomPath`）を使用して下部のみ角丸を実現しています。

3. **MIDI番号マッピング**: A0=21、C8=108という標準MIDI仕様に従っています。生成関数は88鍵盤の不規則なパターン（A0、B0から始まる）を適切に処理します。

4. **ラベル表示**: C鍵盤のみ（C1～C8）、白鍵の下部にオクターブラベルを表示します。

## 仕様書

技術仕様の詳細は[specifications.md](specifications.md)に記載されています：
- 鍵盤の正確な寸法と比率
- 黒鍵配置の数式（N等分アルゴリズム）
- SVGレンダリング仕様
- 色設定
- 将来のMIDI統合計画

この仕様書が実装の真実の情報源（source of truth）であり、鍵盤レンダリングロジックを変更する際は必ず参照してください。

## 重要な作業ルール

**CRITICAL: コード実装前の確認ルール**

実装やファイル変更を行う前に、**必ず以下を実行してください**：

1. **ユーザーに確認を取る**:
   - 何をするのか明確に説明する
   - どのファイルを変更するのか列挙する
   - どのような変更を加えるのか説明する
   - ユーザーの許可を得てから実行する

2. **調査・分析のみを先に行う**:
   - ファイルを読む
   - コードを分析する
   - 問題点を特定する
   - 解決策を提案する
   - **ユーザーが「実装して」と明示的に指示するまで実装しない**

3. **勝手に実装しない**:
   - ファイルの編集（Edit）
   - ファイルの作成（Write）
   - ファイルの削除
   - これらは全て**ユーザーの明示的な許可が必要**

**違反例**：
- ❌ 「修正します」と言ってすぐにEditツールを使う
- ❌ 「新しいファイルを作成します」と言ってすぐにWriteツールを使う
- ❌ ユーザーが「分析して」と言っているのに勝手に実装する

**正しい例**：
- ✅ 問題を分析して、解決策を提案し、「実装しましょうか？」と確認する
- ✅ 変更内容を説明し、「この変更で良いですか？」と確認する
- ✅ ユーザーが「実装して」と言ってから実装する
